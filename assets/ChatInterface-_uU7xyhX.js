import{c as i,r as s,j as e,m as D,B as n,d as j}from"./index-Bjftqz-H.js";import{A as H}from"./config-COe7nS04.js";import{B as y,S as q}from"./sparkles-ascFtAVv.js";import{U as K}from"./user-QZzWKsBE.js";import{M as O}from"./message-square-grivy0jm.js";const Q=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}],["path",{d:"M12 7v5l4 2",key:"1fdv2h"}]],V=i("history",Q);const J=[["path",{d:"M6 8L2 12L6 16",key:"kyvwex"}],["path",{d:"M2 12H22",key:"1m8cig"}]],W=i("move-left",J);const X=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]],L=i("plus",X);const Y=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],Z=i("send",Y);const ee=[["path",{d:"M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z",key:"uqj9uw"}],["path",{d:"M16 9a5 5 0 0 1 0 6",key:"1q6k2b"}],["path",{d:"M19.364 18.364a9 9 0 0 0 0-12.728",key:"ijwkga"}]],te=i("volume-2",ee);const se=[["path",{d:"M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z",key:"uqj9uw"}],["line",{x1:"22",x2:"16",y1:"9",y2:"15",key:"1ewh16"}],["line",{x1:"16",x2:"22",y1:"9",y2:"15",key:"5ykzw1"}]],ae=i("volume-x",se),de=({courseId:r,courseName:p,onClose:B})=>{const[d,c]=s.useState([{id:"1",role:"assistant",content:`Hello! I am your AI Assistant for ${p}. I have indexed the specific materials for this course. How can I help you?`,timestamp:new Date}]),[x,k]=s.useState(""),[v,N]=s.useState(!1),[o,T]=s.useState(!1),[S,z]=s.useState(!1),[b,M]=s.useState([]),[A,I]=s.useState(null),[f,_]=s.useState(null),u=s.useRef(null),[$,E]=s.useState([]),[F,R]=s.useState(!1);s.useEffect(()=>{const t=localStorage.getItem("token");R(!t),(async()=>{const w=await j.chatHistory.where("courseId").equals(r).reverse().sortBy("timestamp");M(w);try{const a={};t&&(a.Authorization=`Bearer ${t}`);const l=await fetch(`${H}/api/chat/history/${r}`,{headers:a});if(l.ok){const m=await l.json();E(m)}}catch(a){console.error("Forum load failed",a)}})()},[r]);const P=async()=>{if(d.length<=1)return;const t=d[1]?.content.slice(0,40)+"..."||"New Chat";await j.chatHistory.add({courseId:r,title:t,timestamp:new Date,messages:d})},U=t=>{c(t),z(!1)},C=async()=>{await P();const t=await j.chatHistory.where("courseId").equals(r).reverse().sortBy("timestamp");M(t),c([{id:Date.now().toString(),role:"assistant",content:`Hello! I am your AI Assistant for ${p}. How can I help you today?`,timestamp:new Date}])};s.useEffect(()=>{u.current&&(u.current.scrollTop=u.current.scrollHeight)},[d,v]);const g=async()=>{if(!x.trim())return;const t={id:Date.now().toString(),role:"user",content:x,timestamp:new Date};c(a=>[...a,t]);const h=x,w=o;A||k(""),N(!0);try{const a=await fetch(`${H}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json",...localStorage.getItem("token")?{Authorization:`Bearer ${localStorage.getItem("token")}`}:{}},body:JSON.stringify({message:h,course_id:r,is_voice:w,ticket_id:A})});if(!a.ok)throw new Error("Connection timeout");const l=await a.json();if(l.status==="queued"){I(l.ticket_id),_({pos:l.position,wait:l.wait_time}),setTimeout(()=>{g()},2e3);return}I(null),_(null);const m={id:Date.now().toString(),role:"assistant",content:l.response,timestamp:new Date};c(G=>[...G,m])}catch{const l={id:Date.now().toString(),role:"assistant",content:"I'm having trouble connecting to the AI Service. Please ensure the local backend is running.",timestamp:new Date};c(m=>[...m,l])}finally{N(!1)}};return e.jsxs(D.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},className:"fixed inset-0 z-[100] bg-white dark:bg-slate-950 flex flex-col sm:m-4 sm:rounded-[2.5rem] sm:shadow-2xl sm:border sm:border-slate-200 sm:dark:border-slate-800 overflow-hidden transition-colors",children:[e.jsxs("div",{className:"h-20 px-8 border-b border-slate-200 dark:border-slate-800 flex items-center justify-between bg-white/50 dark:bg-slate-900/50 backdrop-blur-md",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(n,{variant:"ghost",size:"sm",onClick:B,className:"p-2 rounded-full text-slate-500",children:e.jsx(W,{size:20})}),e.jsx("div",{className:"w-12 h-12 bg-blue-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-blue-500/20",children:e.jsx(y,{size:28})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-lg text-slate-900 dark:text-white leading-tight",children:p}),e.jsxs("div",{className:"flex items-center gap-2 mt-0.5",children:[e.jsx("span",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),e.jsxs("span",{className:"text-[10px] font-bold text-slate-500 uppercase",children:["Workspace ID: ",r]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(n,{variant:"ghost",size:"sm",onClick:C,className:"hidden sm:flex text-slate-500 hover:text-blue-600",title:"New Chat",children:e.jsx(L,{size:20})}),e.jsxs(n,{variant:"ghost",size:"sm",onClick:()=>z(!S),className:"text-slate-500 hover:text-blue-600 relative",children:[e.jsx(V,{size:20}),b.length>0&&e.jsx("span",{className:"absolute top-0 right-0 w-2.5 h-2.5 bg-blue-500 rounded-full border-2 border-white dark:border-slate-900"})]}),e.jsx("div",{className:"h-6 w-px bg-slate-200 dark:bg-slate-800 mx-1 hidden sm:block"}),e.jsxs(n,{variant:o?"secondary":"ghost",size:"sm",onClick:()=>T(!o),className:`rounded-xl gap-2 px-3 border transition-colors ${o?"border-blue-500 bg-blue-50 text-blue-600":"border-slate-200 text-slate-400"}`,children:[o?e.jsx(te,{size:18}):e.jsx(ae,{size:18}),e.jsx("span",{className:"text-[10px] font-black uppercase tracking-widest hidden sm:inline",children:o?"Audio High-Fidelity":"Standard Text"})]}),e.jsx("div",{className:"hidden sm:flex items-center gap-2 px-4 py-2 bg-blue-50 dark:bg-blue-900/30 text-blue-600 rounded-full text-xs font-bold border border-blue-100 dark:border-blue-800 shadow-sm",children:f?e.jsxs("span",{className:"flex items-center gap-2 text-yellow-600 dark:text-yellow-400",children:[e.jsxs("span",{className:"relative flex h-2 w-2",children:[e.jsx("span",{className:"animate-ping absolute inline-flex h-full w-full rounded-full bg-yellow-400 opacity-75"}),e.jsx("span",{className:"relative inline-flex rounded-full h-2 w-2 bg-yellow-500"})]}),"Queue #",f.pos," (",Math.ceil(f.wait),"s)"]}):e.jsxs(e.Fragment,{children:[e.jsx(q,{size:14,className:"animate-pulse"})," AI Status"]})})]})]}),e.jsxs("div",{ref:u,className:"flex-grow overflow-y-auto p-8 space-y-8 scroll-smooth",children:[$.length>0&&e.jsxs("div",{className:"mb-12 border-b-2 border-slate-100 dark:border-slate-800 pb-8",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-8 opacity-50",children:[e.jsx("div",{className:"h-px bg-slate-300 w-24"}),e.jsx("span",{className:"text-[10px] uppercase font-black tracking-widest text-slate-400",children:"Student Community Forum"}),e.jsx("div",{className:"h-px bg-slate-300 w-24"})]}),$.map((t,h)=>e.jsxs("div",{className:"space-y-4 mb-8 opacity-90 hover:opacity-100 transition-opacity",children:[e.jsxs("div",{className:"flex gap-4 items-start",children:[e.jsx("div",{className:"w-8 h-8 rounded-lg bg-orange-100 text-orange-600 flex items-center justify-center flex-shrink-0",children:e.jsx("span",{className:"font-bold text-xs",children:t.user_name.charAt(0)})}),e.jsxs("div",{className:"bg-orange-50/50 dark:bg-orange-900/10 p-4 rounded-2xl rounded-tl-none border border-orange-100 dark:border-orange-800/30",children:[e.jsxs("div",{className:"text-[10px] font-bold text-orange-400 uppercase tracking-widest mb-1",children:[t.user_name," asked:"]}),e.jsx("p",{className:"text-sm font-medium text-slate-700 dark:text-slate-300",children:t.question})]})]}),e.jsx("div",{className:"flex gap-4 items-start ml-8",children:e.jsxs("div",{className:"bg-slate-50 dark:bg-slate-800/50 p-4 rounded-2xl border border-slate-200 dark:border-slate-800 w-full",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(q,{size:12,className:"text-blue-500"}),e.jsx("span",{className:"text-[10px] font-bold text-slate-400 uppercase",children:"AI Answer"})]}),e.jsx("p",{className:"text-sm text-slate-600 dark:text-slate-400 leading-relaxed",children:t.answer})]})})]},`forum-${h}`))]}),d.map(t=>e.jsx("div",{className:`flex ${t.role==="user"?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`flex gap-4 max-w-[85%] md:max-w-[75%] ${t.role==="user"?"flex-row-reverse":""}`,children:[e.jsx("div",{className:`w-10 h-10 rounded-xl flex items-center justify-center flex-shrink-0 shadow-sm ${t.role==="user"?"bg-slate-100 dark:bg-slate-800 text-slate-600":"bg-blue-600 text-white"}`,children:t.role==="user"?e.jsx(K,{size:20}):e.jsx(y,{size:20})}),e.jsxs("div",{className:`p-5 rounded-2xl shadow-sm ${t.role==="user"?"bg-blue-600 text-white rounded-tr-none":"bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100 rounded-tl-none border border-slate-200 dark:border-slate-800"}`,children:[e.jsx("p",{className:"text-[15px] leading-relaxed font-medium",children:t.content}),e.jsx("p",{className:"text-[10px] mt-3 font-bold opacity-40 uppercase tracking-widest",children:t.timestamp.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})]})},t.id)),v&&e.jsxs("div",{className:"flex justify-start",children:[e.jsx("div",{className:"w-10 h-10 rounded-xl bg-blue-600 flex items-center justify-center text-white mr-4 shadow-lg shadow-blue-500/20",children:e.jsx(y,{size:20})}),e.jsxs("div",{className:"bg-white dark:bg-slate-900 p-5 rounded-2xl rounded-tl-none border border-slate-200 dark:border-slate-800 flex items-center gap-1.5 shadow-sm",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-600 rounded-full animate-bounce [animation-duration:0.6s]"}),e.jsx("div",{className:"w-2 h-2 bg-blue-600 rounded-full animate-bounce [animation-duration:0.6s] [animation-delay:0.2s]"}),e.jsx("div",{className:"w-2 h-2 bg-blue-600 rounded-full animate-bounce [animation-duration:0.6s] [animation-delay:0.4s]"})]})]})]}),S&&e.jsx(D.div,{initial:{x:-300,opacity:0},animate:{x:0,opacity:1},exit:{x:-300,opacity:0},className:"absolute top-20 left-0 bottom-0 w-72 bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 z-[90] shadow-2xl overflow-y-auto",children:e.jsxs("div",{className:"p-4",children:[e.jsx("h4",{className:"font-black text-xs uppercase tracking-widest text-slate-400 mb-4 ml-2",children:"Recent Chats"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(n,{variant:"secondary",className:"w-full justify-start gap-2 mb-4",onClick:C,children:[e.jsx(L,{size:16})," New Chat"]}),b.map(t=>e.jsxs("button",{onClick:()=>U(t.messages),className:"w-full text-left p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors flex items-start gap-3 group",children:[e.jsx(O,{size:16,className:"mt-1 text-slate-400 group-hover:text-blue-500 transition-colors"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-bold text-slate-700 dark:text-slate-300 line-clamp-1",children:t.title}),e.jsx("p",{className:"text-[10px] font-medium text-slate-400",children:t.timestamp.toLocaleDateString()})]})]},t.id)),b.length===0&&e.jsx("p",{className:"text-center text-slate-400 text-xs py-10",children:"No history yet."})]})]})}),e.jsx("div",{className:"p-8 border-t border-slate-200 dark:border-slate-800 bg-white/50 dark:bg-slate-950/50 backdrop-blur-xl",children:e.jsxs("div",{className:"max-w-4xl mx-auto flex items-end gap-3 px-5 py-4 bg-slate-100 dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-[1.5rem] shadow-sm",children:[e.jsx("textarea",{title:"Message input",value:x,onChange:t=>k(t.target.value),onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),g())},placeholder:F?"Search community questions (Guest Mode)...":"Ask a question to the class AI...",className:"flex-grow bg-transparent border-none outline-none resize-none py-2 text-base text-slate-800 dark:text-white",rows:1}),e.jsx(n,{onClick:g,disabled:!x.trim(),className:"p-3 bg-blue-600 text-white rounded-xl",children:e.jsx(Z,{size:20})})]})})]})};export{de as ChatInterface};
